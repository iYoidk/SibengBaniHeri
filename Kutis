-- ⚔️ AutoCombat Lite v3 - Immediate Spam Edition
-- Perubahan: M1 dan Skill dikirim tanpa jeda internal (secepat possible)
-- Nama GUI: AutoCombatLite

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

-- === CONFIG ===
local SKILL_SEQ = {
	M1  = "SW_Kioru V2_M1",
	Z   = "SW_Kioru V2_Z",
	OpX = "DF_OpOp_X"
}
local DEFAULT_DELAY = 0 -- default 0 (kamu bisa isi delayBox kalau mau)

-- === FIND REMOTES ===
local SkillAction
pcall(function()
	local chest = ReplicatedStorage:WaitForChild("Chest", 5)
	local remotes = chest and chest:FindFirstChild("Remotes")
	local funcs = remotes and remotes:FindFirstChild("Functions")
	SkillAction = funcs and funcs:FindFirstChild("SkillAction")
end)

if not SkillAction then
	warn("[AutoCombatLite] SkillAction tidak ditemukan!")
	return
end

local MOB = workspace:FindFirstChild("MOB") or workspace:WaitForChild("MOB", 5)
if not MOB then
	warn("[AutoCombatLite] Folder MOB tidak ditemukan!")
	return
end

-- === UTILS ===
local function safeInvoke(skill, data)
	pcall(function()
		if SkillAction and SkillAction.InvokeServer then
			SkillAction:InvokeServer(skill, data)
		elseif SkillAction and SkillAction.FireServer then
			SkillAction:FireServer(skill, data)
		end
	end)
end

local function getTargets()
	local list = {}
	for _, m in ipairs(MOB:GetChildren()) do
		if m:IsA("Model") and m:FindFirstChild("HumanoidRootPart") and m:FindFirstChildOfClass("Humanoid") then
			table.insert(list, m)
		end
	end
	return list
end

local function nearestTarget()
	local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not root then return end
	local best, dist = nil, math.huge
	for _, m in ipairs(getTargets()) do
		local hrp = m:FindFirstChild("HumanoidRootPart")
		local hum = m:FindFirstChildOfClass("Humanoid")
		if hrp and hum and hum.Health > 0 then
			local d = (root.Position - hrp.Position).Magnitude
			if d < dist then dist = d; best = m end
		end
	end
	return best
end

-- === ATTACKS (IMMEDIATE) ===
local function doM1(t)
	if t and t:FindFirstChild("HumanoidRootPart") then
		-- kirim M1 secepat dipanggil
		safeInvoke(SKILL_SEQ.M1, { MouseHit = t.HumanoidRootPart.CFrame })
	end
end

local function doKioruZImmediate(t)
	-- beberapa implementasi Z memerlukan Down lalu Up; kita kirim keduanya tanpa wait
	if not t or not t:FindFirstChild("HumanoidRootPart") then return end
	local hrp = t.HumanoidRootPart
	-- kirim Down lalu Up secepat mungkin
	safeInvoke(SKILL_SEQ.Z, { Type = "Down", MouseHit = hrp.CFrame })
	safeInvoke(SKILL_SEQ.Z, { Type = "Up",   MouseHit = hrp.CFrame })
end

local function doOpXImmediate(t)
	if not t or not t:FindFirstChild("HumanoidRootPart") then return end
	local hrp = t.HumanoidRootPart
	safeInvoke(SKILL_SEQ.OpX, { Type = "Down", MouseHit = hrp.CFrame })
	-- beberapa game butuh hanya Down; tetap kirim Up juga untuk safety (tanpa wait)
	safeInvoke(SKILL_SEQ.OpX, { Type = "Up",   MouseHit = hrp.CFrame })
end

local function doSkillsImmediate(t)
	-- langsung panggil skill yang kamu minta: Kioru Z dan OpX (urut)
	if not t then return end
	-- Kioru Z
	if SKILL_SEQ.Z then
		doKioruZImmediate(t)
	end
	-- OpX
	if SKILL_SEQ.OpX then
		doOpXImmediate(t)
	end
end

-- === SIMPLE GUI (window style, minimize) ===
local gui = Instance.new("ScreenGui")
gui.Name = "AutoCombatLite"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
gui.Parent = game:GetService("CoreGui")

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 300, 0, 180)
frame.Position = UDim2.new(0.05, 0, 0.25, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, -20, 0, 28)
title.Position = UDim2.new(0, 10, 0, 0)
title.Text = "⚔️ AutoCombat Lite v3 (Immediate)"
title.TextColor3 = Color3.new(1,1,1)
title.TextXAlignment = Enum.TextXAlignment.Left
title.BackgroundTransparency = 1
title.Font = Enum.Font.SourceSansBold
title.TextSize = 15

local minimize = Instance.new("TextButton", frame)
minimize.Size = UDim2.new(0, 26, 0, 26)
minimize.Position = UDim2.new(1, -32, 0, 2)
minimize.Text = "-"
minimize.Font = Enum.Font.SourceSansBold
minimize.TextSize = 18
minimize.BackgroundColor3 = Color3.fromRGB(70,70,70)
minimize.TextColor3 = Color3.new(1,1,1)

local toggle = Instance.new("TextButton", frame)
toggle.Size = UDim2.new(0.45, 0, 0, 36)
toggle.Position = UDim2.new(0.03, 0, 0.22, 0)
toggle.Text = "OFF"
toggle.Font = Enum.Font.SourceSansBold
toggle.TextSize = 16
toggle.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
toggle.TextColor3 = Color3.new(1,1,1)

local modeBtn = Instance.new("TextButton", frame)
modeBtn.Size = UDim2.new(0.45, 0, 0, 36)
modeBtn.Position = UDim2.new(0.52, 0, 0.22, 0)
modeBtn.Text = "Mode: Nearest"
modeBtn.Font = Enum.Font.SourceSans
modeBtn.TextSize = 14
modeBtn.BackgroundColor3 = Color3.fromRGB(50,120,200)
modeBtn.TextColor3 = Color3.new(1,1,1)

local atkMode = Instance.new("TextButton", frame)
atkMode.Size = UDim2.new(0.9, 0, 0, 30)
atkMode.Position = UDim2.new(0.05, 0, 0.5, 0)
atkMode.Text = "Attack: Both"
atkMode.Font = Enum.Font.SourceSans
atkMode.TextSize = 14
atkMode.BackgroundColor3 = Color3.fromRGB(50,100,150)
atkMode.TextColor3 = Color3.new(1,1,1)

local delayBox = Instance.new("TextBox", frame)
delayBox.Size = UDim2.new(0.9, 0, 0, 28)
delayBox.Position = UDim2.new(0.05, 0, 0.68, 0)
delayBox.PlaceholderText = "Delay (detik) - 0 = no extra delay"
delayBox.Text = tostring(DEFAULT_DELAY)
delayBox.Font = Enum.Font.SourceSans
delayBox.TextSize = 14
delayBox.BackgroundColor3 = Color3.fromRGB(45,45,45)
delayBox.TextColor3 = Color3.new(1,1,1)
delayBox.ClearTextOnFocus = false

local info = Instance.new("TextLabel", frame)
info.Size = UDim2.new(0.9, 0, 0, 24)
info.Position = UDim2.new(0.05, 0, 0.86, 0)
info.BackgroundTransparency = 1
info.Text = "Status: Idle"
info.TextColor3 = Color3.fromRGB(200,200,200)
info.Font = Enum.Font.SourceSans
info.TextSize = 13

-- === STATE ===
local state = {
	enabled = false,
	mode = "Nearest",
	attackMode = "Both",
	delay = DEFAULT_DELAY,
	minimized = false
}

-- === INTERACTIONS ===
toggle.MouseButton1Click:Connect(function()
	state.enabled = not state.enabled
	if state.enabled then
		toggle.Text = "ON"
		toggle.BackgroundColor3 = Color3.fromRGB(50,200,70)
	else
		toggle.Text = "OFF"
		toggle.BackgroundColor3 = Color3.fromRGB(180,50,50)
	end
end)

modeBtn.MouseButton1Click:Connect(function()
	if state.mode == "Nearest" then
		state.mode = "All"
		modeBtn.Text = "Mode: All"
	else
		state.mode = "Nearest"
		modeBtn.Text = "Mode: Nearest"
	end
end)

atkMode.MouseButton1Click:Connect(function()
	local nextMode = {["Both"]="M1 Only", ["M1 Only"]="Skill Only", ["Skill Only"]="Both"}
	state.attackMode = nextMode[state.attackMode]
	atkMode.Text = "Attack: " .. state.attackMode
end)

delayBox.FocusLost:Connect(function(enter)
	if enter then
		local v = tonumber(delayBox.Text)
		if v and v >= 0 then state.delay = v else delayBox.Text = tostring(state.delay) end
	end
end)

minimize.MouseButton1Click:Connect(function()
	state.minimized = not state.minimized
	if state.minimized then
		for _, c in ipairs(frame:GetChildren()) do
			if c ~= title and c ~= minimize then c.Visible = false end
		end
		frame.Size = UDim2.new(0, 200, 0, 28)
		title.Text = "⚔️ AutoCombat [Hidden]"
	else
		for _, c in ipairs(frame:GetChildren()) do c.Visible = true end
		frame.Size = UDim2.new(0, 300, 0, 180)
		title.Text = "⚔️ AutoCombat Lite v3 (Immediate)"
	end
end)

-- === MAIN LOOP (IMMEDIATE BEHAVIOR) ===
task.spawn(function()
	while true do
		-- tiny yield so we don't freeze host environment; core behavior is "no internal waits"
		task.wait(0.01)
		if not state.enabled then
			info.Text = "Status: Idle"
			continue
		end
		info.Text = "Status: Attacking..."

		local targets = getTargets()
		if #targets == 0 then
			task.wait(0.1)
			continue
		end

		if state.mode == "Nearest" then
			local t = nearestTarget()
			if t then
				-- Immediate behavior: call M1 and skills back-to-back with NO internal waits
				if state.attackMode == "M1 Only" then
					doM1(t)
				elseif state.attackMode == "Skill Only" then
					doSkillsImmediate(t)
				else -- Both
					doM1(t)
					-- no wait between M1 and skills (user requested immediate)
					doSkillsImmediate(t)
				end
				-- user-configurable global delay (can be zero)
				if state.delay and state.delay > 0 then
					task.wait(state.delay)
				end
			end
		else -- All mode: iterate all targets quickly
			for _, t in ipairs(targets) do
				if not state.enabled then break end
				if state.attackMode == "M1 Only" then
					doM1(t)
				elseif state.attackMode == "Skill Only" then
					doSkillsImmediate(t)
				else
					doM1(t)
					doSkillsImmediate(t)
				end
				if state.delay and state.delay > 0 then
					task.wait(state.delay)
				end
			end
		end
	end
end)

print("[AutoCombatLite] Immediate Edition loaded.")
